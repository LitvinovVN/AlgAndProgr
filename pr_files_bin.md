# Работа с двоичными файлами

Для хранения большого количества чисел или данных определённой структуры удобно использовать двоичные файлы.
В двоичных файлах данные считываются и записываются в виде блоков определённого размера.

Для записи данных в двоичный файл необходимо:

1. Создать переменную типа **FILE \***, в которой будет храниться указатель на файл, с помощью оператора **FILE \*filename;**
2. Открыть файл с помощью функции **fopen**.
3. Записать информацию в файл с помощью функции **fwrite**.
4. Закрыть файл с помощью функции fclose.

Для считывания данных из двоичного файла, необходимо:

1. Описать переменную типа **FILE \***.
2. Открыть файл с помощью функции **fopen**.
3. Считать необходимую информацию из файла с помощью функции **fread**, при считывании информации следить за тем, достигнут ли конец файла.
4. Закрыть файл с помощью функции **fclose**.

## Функции, необходимые для работы с двоичными файлами

Для открытия файла предназначена функция:

#### FILE *fopen(const *filename, const char *mode);

где filename — строка, в которой хранится полное имя открываемого файла,

mode — строка, которая определяет режим работы с файлом; возможны следующие значения:

"rb" — открыть двоичный файл в режиме чтения;

"wb" — создать двоичный файл для записи, если файл существует, то его содержимое очищается.

"ab" — создать или открыть двоичный файл для добавления информации в конец файла;

"rb+" — открыть существующий двоичный файл в режиме чтения и записи;

"wb+" — открыть двоичный файл в режиме чтения и записи, существующий файл очищается;

"ab+" — двоичный файл открывается или создаётся для исправления существующей информации и добавления новой в конец файла.

В случае неудачного открытия файла функция fopen возвращает NULL.

После успешного открытия файла указатель содержит адрес 0-го байта файла.
По мере чтения или записи значение указателя смещается на считанное (записанное) количество байт.
Текущее значение указателя — адрес байта, начиная с которого будет происходить операция чтения или записи.

Для закрытия файла предназначена функция

int fclose(FILE *filename);

Она возвращает 0 при успешном закрытии файла и NULL в противном случае.

Для удаления файлов существует функция

int remove(const char *filename);
Эта функция удаляет с диска файл с именем filename. Удаляемый файл должен быть закрыт.
Функция возвращает ненулевое значение, если файл не удалось удалить.

Для переименования файлов предназначена функция

int rename(const char *oldfilename, const char *newfilename);
здесь первый параметр — старое имя файла, второй — новое. Возвращает 0 при удачном завершении программы.

Чтение из двоичного файла осуществляется с помощью функции

fread (void *ptr, size, n, FILE *filename)
Эта функция считывает из файла filename в массив ptr n элементов размера size. Функция возвращает количество считанных элементов.
После чтения из файла указатель файла смещается на n*size байт.

Запись в двоичный файл осуществляется с помощью функции

fwrite (const void *ptr, size, n, FILE *filename);
Функция записывает в файл filename из массива ptr n элементов размера size.
Функция возвращает количество записанных элементов.
После записи информации в файл, указатель файла смещается на n*size байт.

Для контроля достижения конца файла есть функция

int feof(FILE * filename);
Она возвращает ненулевое значение, если достигнут конец файла.

#### Пример 1. Создать двоичный файл data.bin, куда записать целое число n и n вещественных чисел

```c++
// g++ files_bin_01.cpp -o app
// ./app
#include <iostream>
#include <fstream>
using namespace std;
int main()
{
	FILE *f; //Описание файловой переменной.
	int i, n; double a;
	f=fopen ("data.bin", "wb"); //Создание двоичного файла в режиме записи.
	cout<<"n = "; cin>>n; //Ввод числа n.
	fwrite (&n, sizeof(int), 1, f); //Запись числа в двоичный файл.
	for (i = 0; i < n; i++) //Цикл для ввода n вещественных чисел.
	{
		cout << "a = "; cin>>a; //Ввод очередного вещественного числа.
		fwrite(&a, sizeof(double), 1, f); //Запись числа в двоичный файл.
	}
	fclose (f); //Закрыть файл.
	return 0;
}
```


#### Пример 2. Вывести на экран содержимое двоичного файла data.bin, содержащего целое число n и n вещественных чисел
```c++
// g++ files_bin_02.cpp -o app
// ./app
#include <iostream>
#include <fstream>
using namespace std;
int main()
{
	FILE *f; //Описание файловой переменной.
	int i, n;
	f = fopen("data.bin", "rb"); //Открыть существующий двоичный файл в режиме чтения.
	fread(&n, sizeof(int), 1, f); //Читать из файла целое число в переменную n.
	cout << "n = " << n << endl; //Вывод n на экран.

	double *arr = new double[n]; //Выделение памяти для массива из n чисел.
	//Чтение n вещественных чисел размером sizeof(double) каждое из файла f в массив arr.
	fread(arr, sizeof(double), n, f);
	for (i = 0; i < n; i++) //Вывод массива на экран.
	{
		cout << arr[i] << "\t";
	}
	cout << endl;
	fclose(f); //Закрыть файл.
	return 0;
}
```

Двоичный файл — последовательная структура данных, после открытия файла доступен первый байт.
Можно последовательно считывать данные из файла или записывать их в него.
При необходимости считывания отдельных фрагментов данных из двоичного файла следует использовать функцию перемещения указателя файла к заданному байту:

int fseek(FILE *F, long int offset, int origin);

Функция устанавливает указатель текущей позиции файла F, в соответствии со значениями начала отсчёта origin и смешения offset.
Параметр offset равен количеству байтов, на которые будет смещён указатель файла относительно начала отсчёта, заданного параметром origin.
Если значение offset положительно, то указатель файла смещается вперёд, если отрицательно — назад.
Параметр origin должен принимать одно из следующих значений, определённых в заголовке stdio.h:

SEEK_SET — отсчёт смещения offset вести с начала файла;

SEEK_CUR — отсчёт смещения offset вести с текущей позиции файла;

SEEK_END — отсчёт смещения offset вести с конца файла.

Функция возвращает нулевое значение при успешном выполнении операции и ненулевое, если возник сбой при выполнении смещения.

Функция fseek фактически реализует прямой доступ к любому значению в файле. Необходимо только знать месторасположение (номер байта) значения в файле. Рассмотрим использование прямого доступа в двоичных файлах на примере решения следующей задачи.


#### Пример 3. В созданном в примере 1 двоичном файле data.bin поменять местами наибольшее и наименьшее из вещественных чисел.

Алгоритм решения задачи состоит из следующих этапов:

1. Чтение вещественных чисел из файла в массив a.
2. Поиск в массиве a максимального (max) и минимального (min) значения и их номеров (imax, imin).
3. Перемещение указателя файла к максимальному значению и запись min.
4. Перемещение указателя файла к минимальному значению и запись max.

```c++
#include <iostream>
#include <fstream>
using namespace std;
int main()
{
	FILE *f; //Описание файловой переменной.
	int n, imax, imin;
	double max, min;
	f = fopen("data.bin", "rb+"); //Открыть файл в режиме чтения и записи.
	fread(&n, sizeof(int), 1, f ); //Считать из файла в переменную n количество элементов в	файле.
	double *arr = new double[n]; //Выделить память для хранения вещественных чисел,
	//эти числа будут хранится в массиве arr.
	fread(arr, sizeof(double), n, f); //Считать из файла в массив arr вещественные числа.
	//Поиск максимального max, минимального min элемента в массиве arr, и их индексов imax и imin.
	imax = imin = 0;
	max = min = arr[0];
	for(int i = 1; i < n; i++)
	{
		if(arr[i] > max)
		{
			max = arr[i];
			imax = i;
		}
		if(a[i] < min )
		{
			min = arr[i];
			imin = i;
		}
	}
	//Перемещение указателя к максимальному элементу.
	fseek(f, sizeof(int) + imax * sizeof(double), SEEK_SET);
	//Запись min вместо максимального элемента файла.
	fwrite(&min, sizeof(double), 1, f);
	//Перемещение указателя к минимальному элементу.
	fseek(f, sizeof(int) + imin * sizeof(double), SEEK_SET);
	//Запись max вместо минимального элемента файла.
	fwrite (&max, sizeof(double), 1, f);
	//Закрытие файла.
	fclose(f);
	//Освобождение памяти, выделенной под массив a.
	delete[] arr;
	return 0;
}
```